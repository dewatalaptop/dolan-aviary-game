<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dolan Aviary - Real Asset Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

        /* --- BASE STYLES --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body {
            margin: 0; padding: 0;
            height: 100dvh; width: 100vw;
            background-color: #222;
            font-family: 'Fredoka One', cursive;
            overflow: hidden; touch-action: none; 
            display: flex; justify-content: center; align-items: center;
        }

        #game-stage {
            position: relative;
            width: 100%; max-width: 480px; height: 100%;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            background: #87CEEB; 
        }

        canvas { display: block; width: 100%; height: 100%; z-index: 1; }

        /* --- UI LAYERS --- */
        .ui-layer { position: absolute; width: 100%; pointer-events: none; z-index: 50; text-align: center; }
        
        #score-display {
            top: 10%; font-size: 4rem; color: #FFD700;
            -webkit-text-stroke: 4px #8B4513; text-shadow: 5px 5px 0 rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        .score-pop { transform: scale(1.3); }

        #tutorial-hint {
            top: 55%; width: 100%;
            font-size: 1rem; color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            animation: pulse 1.5s infinite;
            display: none; letter-spacing: 1px;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(0.95); } }

        #flash-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: white; opacity: 0; pointer-events: none; z-index: 99;
            transition: opacity 0.1s ease-out;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            z-index: 60; display: none;
        }

        #loading-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #87CEEB; z-index: 100;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            color: white; font-size: 1.5rem; text-shadow: 2px 2px 0 #000;
        }

        /* --- UI Elements --- */
        #user-info {
            position: absolute; top: 15px; left: 15px; z-index: 70;
            display: flex; align-items: center; gap: 10px;
            background: #FFF8DC; padding: 8px 14px; border-radius: 20px;
            border: 3px solid #8B4513; box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            pointer-events: auto; display: none; color: #543847;
        }
        #user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #8B4513; }
        #user-name { font-size: 0.8rem; }

        .btn {
            background: linear-gradient(to bottom, #FF7F50, #E86101);
            border: none; border-radius: 25px;
            box-shadow: 0 6px 0 #A04000, 0 8px 10px rgba(0,0,0,0.3);
            color: white; padding: 16px 24px; font-size: 1rem;
            font-family: inherit; cursor: pointer; margin: 10px;
            text-transform: uppercase; width: 85%; max-width: 300px;
            pointer-events: auto; position: relative; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            transition: all 0.1s;
        }
        .btn:active { top: 6px; box-shadow: 0 0 0 #A04000, 0 2px 5px rgba(0,0,0,0.3); }
        .btn-google { background: linear-gradient(to bottom, #4285F4, #3367D6); box-shadow: 0 6px 0 #2a56c6, 0 8px 10px rgba(0,0,0,0.3); }
        .btn-green { background: linear-gradient(to bottom, #73BF2E, #5FA026); box-shadow: 0 6px 0 #4d821f, 0 8px 10px rgba(0,0,0,0.3); }

        .lb-container {
            width: 90%; max-width: 340px; background: #FFF8DC;
            border: 4px solid #8B4513; border-radius: 15px;
            padding: 12px; margin-bottom: 20px; pointer-events: auto;
            box-shadow: 0 8px 0 rgba(0,0,0,0.2);
        }
        .tab {
            flex: 1; padding: 10px; font-size: 0.7rem; cursor: pointer;
            background: #DEB887; border: 2px solid #8B4513; color: #8B4513; text-align: center;
            border-radius: 12px 12px 0 0; margin: 0 2px;
        }
        .tab.active { background: #E86101; color: white; border-bottom: none; transform: translateY(2px); }
        #lb-list { height: 180px; overflow-y: auto; background: #fff; border: 2px solid #8B4513; border-radius: 0 0 12px 12px; padding: 8px; }
        .lb-row { font-family: sans-serif; font-weight: bold; }
    </style>
</head>
<body>

    <div id="game-stage">
        <canvas id="gameCanvas"></canvas>
        
        <div id="loading-screen">
            <div>MEMUAT ASET...</div>
            <div style="font-size:0.8rem; margin-top:10px;">Mohon Tunggu Sebentar</div>
        </div>

        <div class="ui-layer" id="score-display" style="display:none;">0</div>
        <div class="ui-layer" id="tutorial-hint">TAP / SPASI UNTUK TERBANG</div>
        <div id="flash-overlay"></div>
        
        <div id="user-info">
            <img id="user-avatar" src="" alt="">
            <div>
                <div id="user-name">Player</div>
                <div id="loc-badge">üìç Mencari Lokasi...</div>
            </div>
        </div>

        <div id="screen-start" class="screen" style="display: none;">
            <h1 style="color:#FFD700; -webkit-text-stroke:4px #004466; text-shadow:8px 8px 0 rgba(0,0,0,0.2); font-size:3.5rem; text-align:center; margin-bottom:20px; line-height: 1.1; transform: rotate(-3deg);">
                DOLAN<br>AVIARY
            </h1>
            
            <div id="login-section" style="width:100%; text-align:center;">
                <p style="color:#fff; font-size:0.9rem; margin-bottom:15px; text-shadow: 2px 2px 4px #000;">Login untuk Simpan Skor</p>
                <button class="btn btn-google" id="btn-login">üîë Login Google</button>
                <button class="btn btn-green" id="btn-guest">Main Tanpa Login</button>
            </div>
            
            <div id="play-section" style="display:none; text-align:center; width: 100%;">
                <button class="btn btn-green" id="btn-start" style="font-size: 1.4rem; padding: 20px 30px;">START ‚ñ∂</button>
                <button class="btn" id="btn-logout" style="background:#777; box-shadow: 0 6px 0 #555; width:auto; font-size:0.8rem; padding: 12px 18px;">Logout</button>
            </div>
        </div>

        <div id="screen-over" class="screen">
            <h2 style="color:#FF6B6B; -webkit-text-stroke:3px #8B0000; text-shadow:4px 4px 0 rgba(0,0,0,0.2); font-size:3rem; margin-bottom:15px; transform: rotate(2deg);">GAME OVER</h2>
            <div style="background:#FFF8DC; border:4px solid #8B4513; padding:15px 25px; border-radius:20px; text-align:center; margin-bottom:20px; box-shadow: 0 8px 0 rgba(0,0,0,0.2);">
                <div style="font-size:1rem; color:#8B4513; margin-bottom: 5px;">SKOR KAMU</div>
                <div id="final-score" style="font-size:3.5rem; color:#E86101; -webkit-text-stroke:2px #fff; text-shadow: 3px 3px 0 rgba(0,0,0,0.3);">0</div>
            </div>
            <div class="lb-container">
                <div class="tabs">
                    <div class="tab active" id="tab-global">GLOBAL</div>
                    <div class="tab" id="tab-local">LOKAL</div>
                </div>
                <div id="lb-list">
                    <div style="text-align:center; padding:20px; font-size:0.8rem; color:#888;">Memuat...</div>
                </div>
            </div>
            <button class="btn btn-green" id="btn-restart" style="font-size: 1.2rem;">MAIN LAGI ‚Ü∫</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } 
               from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, where, onSnapshot } 
               from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDH6cBMyBCNdzG_tdJNs28AZZIm8HnO8l4",
            authDomain: "flytap-ca3ee.firebaseapp.com",
            projectId: "flytap-ca3ee",
            storageBucket: "flytap-ca3ee.firebasestorage.app",
            messagingSenderId: "690738199480",
            appId: "1:690738199480:web:b1b442690440db79016d4d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let playerCity = "Unknown";
        let lbMode = 'global';
        let unsubscribe = null;
        let userHighScore = 0; 

        async function detectLocation() {
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                if(data.city) {
                    playerCity = data.city;
                    document.getElementById('loc-badge').innerText = `üìç ${playerCity}`;
                }
            } catch(e) { console.log("Loc fail"); }
        }
        detectLocation();

        const uiLogin = document.getElementById('login-section');
        const uiPlay = document.getElementById('play-section');
        const uiInfo = document.getElementById('user-info');

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                uiLogin.style.display = 'none';
                uiPlay.style.display = 'block';
                uiInfo.style.display = 'flex';
                document.getElementById('user-name').innerText = user.displayName;
                document.getElementById('user-avatar').src = user.photoURL;
                loadLeaderboard();
            } else {
                uiLogin.style.display = 'block';
                uiPlay.style.display = 'none';
                uiInfo.style.display = 'none';
                userHighScore = 0;
            }
        });

        document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('btn-logout').onclick = () => signOut(auth);
        document.getElementById('btn-guest').onclick = () => { game.start(); };

        const lbList = document.getElementById('lb-list');
        const tabGlobal = document.getElementById('tab-global');
        const tabLocal = document.getElementById('tab-local');

        function switchTab(mode) {
            lbMode = mode;
            if(mode === 'global') {
                tabGlobal.classList.add('active'); tabLocal.classList.remove('active');
            } else {
                tabGlobal.classList.remove('active'); tabLocal.classList.add('active');
            }
            loadLeaderboard();
        }

        tabGlobal.onclick = () => switchTab('global');
        tabLocal.onclick = () => switchTab('local');

        function loadLeaderboard() {
            if(unsubscribe) unsubscribe();
            lbList.innerHTML = '<div style="text-align:center; padding:20px; font-size:0.8rem;">Memuat...</div>';

            let q;
            const ref = collection(db, "leaderboard");

            if (lbMode === 'local') {
                q = query(ref, where("city", "==", playerCity), orderBy("score", "desc"), limit(10));
            } else {
                q = query(ref, orderBy("score", "desc"), limit(10));
            }

            unsubscribe = onSnapshot(q, (snapshot) => {
                lbList.innerHTML = "";
                if(snapshot.empty) {
                    lbList.innerHTML = `<div style="text-align:center; padding:20px; font-size:0.8rem;">Belum ada skor.</div>`;
                    return;
                }
                let rank = 1;
                snapshot.forEach((doc) => {
                    const d = doc.data();
                    const isMe = currentUser && d.uid === currentUser.uid;
                    if(isMe && d.score > userHighScore) { userHighScore = d.score; }

                    const row = document.createElement('div');
                    row.className = 'lb-row';
                    if(isMe) row.classList.add('lb-me');
                    
                    let locTag = lbMode === 'global' ? `<span class="lb-city">(${d.city||'?'})</span>` : '';
                    
                    row.innerHTML = `
                        <span style="flex:1; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
                            #${rank} ${d.name} ${locTag}
                        </span>
                        <span style="font-weight:bold; color:#E86101;">${d.score}</span>
                    `;
                    lbList.appendChild(row);
                    rank++;
                });
            });
        }

        window.saveScore = async (score) => {
            if (!currentUser || score === 0) return;
            if (score <= userHighScore) return;
            try {
                await addDoc(collection(db, "leaderboard"), {
                    name: currentUser.displayName,
                    uid: currentUser.uid,
                    photo: currentUser.photoURL,
                    score: score,
                    city: playerCity,
                    timestamp: new Date()
                });
                userHighScore = score;
            } catch (e) { console.error(e); }
        };
    </script>

    <script>
        // --- AUDIO ENGINE ---
        const AudioEngine = {
            ctx: null,
            init: function() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            play: function(type) {
                if(!this.ctx) return; if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.ctx.destination); const now = this.ctx.currentTime;
                
                if (type === 'jump') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(200, now); osc.frequency.exponentialRampToValueAtTime(450, now + 0.15);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                } else if (type === 'score') {
                    osc.type = 'triangle'; 
                    osc.frequency.setValueAtTime(600, now); osc.frequency.setValueAtTime(800, now + 0.1);
                    gain.gain.setValueAtTime(0.15, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                } else if (type === 'hit') {
                    osc.type = 'sawtooth'; 
                    osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                    gain.gain.setValueAtTime(0.25, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                }
            }
        };

        // --- GAME ENGINE ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false }); 

        const CONFIG = {
            gravity: 1200, jump: 360, speed: 170,
            gap: 135, pipeW: 65 
        };

        const assets = {
            // Placeholder for procedural assets
            pipe: null, ground: null, bgFar: null, bgMid: null,
            // External Images
            imgBirdUp: null,
            imgBirdDown: null,
            imgRusa: null,
            imgKelinci: null,
            imgDomba: null
        };

        const imageURLs = {
            birdUp: 'https://res.cloudinary.com/dn60ib3ur/image/upload/v1766581827/IMG_7776_qlmxw3.png',
            birdDown: 'https://res.cloudinary.com/dn60ib3ur/image/upload/v1766581827/IMG_7775_teoy4m.png',
            rusa: 'https://res.cloudinary.com/dn60ib3ur/image/upload/v1766583160/IMG_7781_s5gqsi.png',
            kelinci: 'https://res.cloudinary.com/dn60ib3ur/image/upload/v1766583166/IMG_7780_fdrcyi.png',
            domba: 'https://res.cloudinary.com/dn60ib3ur/image/upload/v1766583165/IMG_7782_f6h4cq.png'
        };

        // Load Single Image Helper
        function loadImg(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => resolve(img);
                img.onerror = () => reject(url);
                img.src = url;
            });
        }

        async function initAllAssets() {
            try {
                // 1. Load External Images
                const [bUp, bDown, rusa, kelinci, domba] = await Promise.all([
                    loadImg(imageURLs.birdUp),
                    loadImg(imageURLs.birdDown),
                    loadImg(imageURLs.rusa),
                    loadImg(imageURLs.kelinci),
                    loadImg(imageURLs.domba)
                ]);

                assets.imgBirdUp = bUp;
                assets.imgBirdDown = bDown;
                assets.imgRusa = rusa;
                assets.imgKelinci = kelinci;
                assets.imgDomba = domba;

                // 2. Generate Procedural Environment (dengan setting cerah/indah)
                const cP = createAssetCanvas(CONFIG.pipeW, 600); drawCartoonTree(cP.ctx); assets.pipe = cP.cvs;
                const cG = createAssetCanvas(480, 130); drawCartoonGround(cG.ctx); assets.ground = cG.cvs;
                const cC = createAssetCanvas(480, 640); drawCartoonBgFar(cC.ctx); assets.bgFar = cC.cvs;
                
                // BG Mid (Sawah) butuh gambar hewan yang sudah diload
                const cS = createAssetCanvas(480, 200); drawCartoonBgMid(cS.ctx); assets.bgMid = cS.cvs;

                // Selesai Load
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('screen-start').style.display = 'flex';
                resize();
                requestAnimationFrame(loop);

            } catch (err) {
                console.error("Gagal memuat gambar:", err);
                document.getElementById('loading-screen').innerHTML = "Gagal memuat aset gambar.<br>Cek koneksi internet.";
            }
        }

        function createAssetCanvas(w, h) {
            const c = document.createElement('canvas'); c.width = w; c.height = h;
            c.getContext('2d').font = "bold 18px 'Fredoka One', sans-serif"; 
            return { cvs: c, ctx: c.getContext('2d') };
        }

        function drawRoundedRect(ctx, x, y, w, h, r, fill, stroke) {
            ctx.beginPath(); ctx.moveTo(x+r, y); ctx.lineTo(x+w-r, y); ctx.quadraticCurveTo(x+w, y, x+w, y+r);
            ctx.lineTo(x+w, y+h-r); ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h); ctx.lineTo(x+r, y+h);
            ctx.quadraticCurveTo(x, y+h, x, y+h-r); ctx.lineTo(x, y+r); ctx.quadraticCurveTo(x, y, x+r, y);
            ctx.closePath(); if(fill) { ctx.fillStyle = fill; ctx.fill(); } if(stroke) { ctx.strokeStyle = stroke; ctx.stroke(); }
        }

        // --- PROCEDURAL ENVIRONMENTS (UPDATED FOR "CERAH/INDAH") ---

        function drawCartoonTree(ctx) {
            let w = CONFIG.pipeW;
            const barkGrad = ctx.createLinearGradient(0,0,w,0);
            barkGrad.addColorStop(0, "#8B4513"); barkGrad.addColorStop(0.5, "#A0522D"); barkGrad.addColorStop(1, "#6B3E23"); // Lebih cerah
            ctx.fillStyle = barkGrad; ctx.fillRect(0,0,w,600);
            
            ctx.strokeStyle = "rgba(0,0,0,0.1)"; ctx.lineWidth = 2;
            ctx.beginPath(); for(let i=10; i<w; i+=15) { ctx.moveTo(i,0); ctx.lineTo(i+Math.random()*5-2.5, 600); } ctx.stroke();

            const leafColors = ["#32CD32", "#228B22", "#00FF00"]; // Hijau daun lebih neon/segar
            for(let y=-20; y<620; y+=30) {
                drawLeafCluster(ctx, -15, y, leafColors);
                drawLeafCluster(ctx, w-5, y, leafColors);
            }
            ctx.fillStyle = "#A0522D"; ctx.fillRect(0,0,w,10); ctx.fillRect(0,590,w,10);
        }
        function drawLeafCluster(ctx, x, y, colors) {
            for(let i=0; i<5; i++) {
                ctx.fillStyle = colors[i%3]; ctx.beginPath();
                ctx.arc(x + Math.random()*20-10, y + Math.random()*25-12.5, 10+Math.random()*5, 0, Math.PI*2);
                ctx.fill();
            }
        }

        function drawCartoonGround(ctx) {
            // Rumput Cerah
            const grassGrad = ctx.createLinearGradient(0,0,0,20);
            grassGrad.addColorStop(0, "#76EE00"); grassGrad.addColorStop(1, "#458B00");
            ctx.fillStyle = grassGrad; ctx.fillRect(0,0,480,25);
            
            ctx.strokeStyle = "#ADFF2F"; ctx.lineWidth=2; ctx.beginPath();
            for(let i=0;i<480;i+=10) { ctx.moveTo(i,5); ctx.lineTo(i+3,0); ctx.moveTo(i+2,7); ctx.lineTo(i+5,2); } ctx.stroke();

            // Tanah
            const dirtGrad = ctx.createLinearGradient(0,25,0,130);
            dirtGrad.addColorStop(0, "#8B4513"); dirtGrad.addColorStop(1, "#5E2612");
            ctx.fillStyle = dirtGrad; ctx.fillRect(0,25,480,105);
        }

        function drawCartoonBgFar(ctx) {
            // LANGIT CERAH (Cyan ke Biru Putih)
            const skyGrad = ctx.createLinearGradient(0,0,0,640);
            skyGrad.addColorStop(0, "#4facfe"); // Cyan cerah
            skyGrad.addColorStop(0.6, "#00f2fe"); // Biru neon
            skyGrad.addColorStop(1, "#ffffff"); // Putih di horizon
            ctx.fillStyle = skyGrad; ctx.fillRect(0,0,480,640);

            // MATAHARI (Glow)
            const sunGrad = ctx.createRadialGradient(400, 100, 10, 400, 100, 80);
            sunGrad.addColorStop(0, "rgba(255,255,200, 0.9)");
            sunGrad.addColorStop(1, "rgba(255,255,255, 0)");
            ctx.fillStyle = sunGrad; ctx.beginPath(); ctx.arc(400, 100, 80, 0, Math.PI*2); ctx.fill();

            // Awan Putih Bersih
            ctx.fillStyle = "rgba(255,255,255,0.9)";
            drawCloud(ctx, 100, 150, 60); drawCloud(ctx, 350, 80, 50); drawCloud(ctx, 250, 250, 40);

            // GUNUNG (Hijau Segar & Teal)
            let gy = 640 - 280; 
            // Gunung Jauh
            ctx.fillStyle = "#20B2AA"; // LightSeaGreen
            ctx.beginPath(); ctx.moveTo(0,gy+100);
            ctx.quadraticCurveTo(100, gy-50, 200, gy+20); ctx.quadraticCurveTo(350, gy-80, 480, gy+50);
            ctx.lineTo(480, 640); ctx.lineTo(0, 640); ctx.fill();
            // Gunung Dekat
            ctx.fillStyle = "#3CB371"; // MediumSeaGreen
            ctx.beginPath(); ctx.moveTo(0,gy+150);
            ctx.quadraticCurveTo(150, gy+50, 300, gy+120); ctx.quadraticCurveTo(400, gy+80, 480, gy+180);
            ctx.lineTo(480, 640); ctx.lineTo(0, 640); ctx.fill();
        }
        function drawCloud(ctx, x, y, s) {
            ctx.beginPath(); ctx.arc(x, y, s*0.8, 0, Math.PI*2);
            ctx.arc(x+s*0.7, y-s*0.3, s*0.6, 0, Math.PI*2); ctx.arc(x-s*0.7, y-s*0.3, s*0.6, 0, Math.PI*2);
            ctx.arc(x+s*0.4, y+s*0.2, s*0.5, 0, Math.PI*2); ctx.fill();
        }

        function drawCartoonBgMid(ctx) {
            // SAWAH (Hijau Kekuningan Cerah)
            const fieldGrad = ctx.createLinearGradient(0,0,0,200);
            fieldGrad.addColorStop(0, "#76b852"); // Hijau fresh
            fieldGrad.addColorStop(0.5, "#8DC26F");
            fieldGrad.addColorStop(1, "#4C8C2F");
            ctx.fillStyle = fieldGrad; ctx.fillRect(0,0,480,200);
            
            // Pantulan air lebih jelas
            ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.lineWidth = 3; ctx.beginPath();
            for(let y=20; y<200; y+=30) {
                ctx.moveTo(0, y); for(let x=0; x<480; x+=20) { ctx.quadraticCurveTo(x+10, y+Math.sin(x)*5, x+20, y); }
            } ctx.stroke();

            // PLANG KAYU
            const signX = 240; const signY = 80;
            ctx.fillStyle = "#8B4513"; ctx.fillRect(signX-60, signY+30, 15, 90); ctx.fillRect(signX+45, signY+30, 15, 90);
            ctx.save(); ctx.translate(signX, signY); ctx.rotate(-0.05);
            const woodGrad = ctx.createLinearGradient(-80,0,80,0); woodGrad.addColorStop(0, "#F4A460"); woodGrad.addColorStop(1, "#D2691E");
            drawRoundedRect(ctx, -90, -30, 180, 60, 10, woodGrad, "#8B4513");
            ctx.fillStyle="#5C3A21"; ctx.beginPath(); ctx.arc(-75,0,4,0,Math.PI*2); ctx.arc(75,0,4,0,Math.PI*2); ctx.fill();
            ctx.fillStyle = "#3E2A22"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.shadowColor = "rgba(255,255,255,0.4)"; ctx.shadowOffsetX=1; ctx.shadowOffsetY=1;
            ctx.fillText("DOLAN AVIARY", 0, 2);
            ctx.restore();

            // --- EXTERNAL ANIMALS ---
            // Menggambar gambar yang sudah diload
            
            // Rusa (Kiri)
            if(assets.imgRusa) ctx.drawImage(assets.imgRusa, 30, 130, 60, 60);
            
            // Domba (Kanan)
            if(assets.imgDomba) ctx.drawImage(assets.imgDomba, 380, 140, 50, 50);

            // Kelinci (Tengah dekat plang)
            if(assets.imgKelinci) ctx.drawImage(assets.imgKelinci, 200, 150, 40, 40);
        }

        const game = {
            state: 'START', score: 0,
            bird: { y: 0, v: 0, rot: 0 },
            pipes: [],
            bgOff: 0, cityOff: 0, groundOff: 0,
            timeAccum: 0, graceTime: 0, lastJump: 0,  
            
            start: function() {
                resize(); AudioEngine.init(); 
                this.state = 'PLAY';
                this.bird.y = canvas.height / 2 - 50; this.bird.v = 0; this.bird.rot = 0;
                this.pipes = []; this.score = 0; this.timeAccum = 0;
                this.graceTime = 1.5; this.lastJump = 0;
                document.getElementById('score-display').innerText = 0;
                document.getElementById('score-display').style.display = 'block'; 
                document.getElementById('tutorial-hint').style.display = 'block';
                setTimeout(() => document.getElementById('tutorial-hint').style.display = 'none', 3000);
                showScreen(null);
            },
            
            over: function() {
                AudioEngine.play('hit'); this.state = 'OVER';
                const flash = document.getElementById('flash-overlay');
                flash.style.opacity = 0.6; setTimeout(() => flash.style.opacity = 0, 150);
                document.getElementById('final-score').innerText = this.score;
                showScreen('screen-over');
                if(window.saveScore) window.saveScore(this.score);
            }
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            if(id) document.getElementById(id).style.display = 'flex';
        }

        let lastTime = performance.now();
        function loop(timestamp) {
            const dt = Math.min((timestamp - lastTime) / 1000, 0.06);
            lastTime = timestamp;
            if (game.state === 'PLAY') updatePhysics(dt);
            else if (game.state === 'START') {
                game.groundOff = (game.groundOff + CONFIG.speed * dt) % 480;
                game.cityOff = (game.cityOff + CONFIG.speed * 0.05 * dt) % 480;
                game.bird.y = canvas.height/2 - 50 + Math.sin(timestamp/300)*15;
            }
            draw(dt); requestAnimationFrame(loop);
        }

        function updatePhysics(dt) {
            if (game.graceTime > 0) game.graceTime -= dt;
            game.bird.v += CONFIG.gravity * dt; game.bird.y += game.bird.v * dt;
            if(game.bird.v < 0) game.bird.rot = Math.max(-0.4, game.bird.rot - 3 * dt);
            else game.bird.rot = Math.min(1.2, game.bird.rot + 2.5 * dt);

            game.groundOff = (game.groundOff + CONFIG.speed * dt) % 480;
            game.bgOff = (game.bgOff + CONFIG.speed * 0.3 * dt) % 480; 
            game.cityOff = (game.cityOff + CONFIG.speed * 0.05 * dt) % 480; 

            game.timeAccum += dt;
            if(game.timeAccum > 1.5) {
                game.timeAccum = 0;
                let groundY = canvas.height - 130; let minSafe = 80; let maxSafe = groundY - CONFIG.gap - 80;
                let h;
                if(game.pipes.length === 0) h = Math.floor(Math.random() * (maxSafe - minSafe + 1) + minSafe);
                else {
                    let prevH = game.pipes[game.pipes.length - 1].topH;
                    let change = (Math.random() * 250 * 2) - 250; h = prevH + change;
                    if (h < minSafe) h = minSafe; if (h > maxSafe) h = maxSafe;
                }
                game.pipes.push({ x: canvas.width, topH: h, passed: false });
            }

            // Hitbox
            const bX = 60; const bW = 30; const bH = 28;
            for(let i=0; i<game.pipes.length; i++) {
                let p = game.pipes[i]; p.x -= CONFIG.speed * dt;
                if (bX + bW/2 > p.x + 8 && bX - bW/2 < p.x + CONFIG.pipeW - 8) {
                    if (game.bird.y - bH/2 < p.topH + 12 || game.bird.y + bH/2 > p.topH + CONFIG.gap - 12) {
                        if (game.graceTime <= 0) game.over();
                    }
                }
                if (p.x + CONFIG.pipeW < bX && !p.passed) {
                    game.score++; AudioEngine.play('score');
                    const sd = document.getElementById('score-display'); sd.innerText = game.score;
                    sd.classList.remove('score-pop'); void sd.offsetWidth; sd.classList.add('score-pop');
                    p.passed = true;
                }
                if (p.x < -CONFIG.pipeW) { game.pipes.shift(); i--; }
            }
            if(game.bird.y >= canvas.height - 130 - 20) game.over();
        }

        function draw(dt) {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            let groundY = canvas.height - 130;
            
            // 1. BG Jauh
            ctx.drawImage(assets.bgFar, 0, 640 - canvas.height, 480, canvas.height, 0, 0, canvas.width, canvas.height);

            // 2. BG Tengah
            let bo = Math.floor(game.bgOff);
            let midY = groundY - 200 + 20; 
            ctx.drawImage(assets.bgMid, -bo, midY); ctx.drawImage(assets.bgMid, 480-bo, midY);
            
            // 3. Pipa
            for(let p of game.pipes) {
                let px = Math.floor(p.x);
                ctx.save(); ctx.translate(px, p.topH); ctx.scale(1, -1); ctx.drawImage(assets.pipe, 0, 0); ctx.restore();
                ctx.drawImage(assets.pipe, px, p.topH + CONFIG.gap);
            }
            
            // 4. Tanah
            let go = Math.floor(game.groundOff);
            ctx.drawImage(assets.ground, -go, groundY); ctx.drawImage(assets.ground, 480-go, groundY);
            
            // 5. External Asset: BIRD
            ctx.save(); ctx.translate(60, game.bird.y); ctx.rotate(game.bird.rot);
            if (game.graceTime > 0 && Math.floor(Date.now() / 100) % 2 === 0) ctx.globalAlpha = 0.5;
            
            let birdImg = assets.imgBirdUp;
            // Gunakan gambar jatuh jika velocity positif (turun) atau saat animasi start
            if (game.state === 'PLAY') { 
                if (game.bird.v > 100) birdImg = assets.imgBirdDown; 
            } else { 
                if (Math.sin(Date.now() / 200) > 0) birdImg = assets.imgBirdDown; 
            }
            
            // Gambar image burung (ukuran disesuaikan, misal 50x40 px)
            if(birdImg) ctx.drawImage(birdImg, -25, -20, 50, 40);
            
            ctx.restore(); ctx.globalAlpha = 1.0;
        }

        function inputAction(e) {
            if(e.target.closest('button') || e.target.closest('.lb-container')) return;
            if(game.state === 'START') game.start();
            else if(game.state === 'PLAY') {
                const now = Date.now();
                if (now - game.lastJump > 100) { 
                    game.bird.v = -CONFIG.jump; game.lastJump = now;
                    AudioEngine.play('jump'); document.getElementById('tutorial-hint').style.display = 'none';
                }
            }
        }

        const stage = document.getElementById('game-stage');
        stage.addEventListener('pointerdown', inputAction);
        window.addEventListener('keydown', (e) => { if(['Space', 'ArrowUp', 'KeyW'].includes(e.code)) inputAction(e); });
        document.getElementById('btn-start').onclick = () => game.start();
        document.getElementById('btn-restart').onclick = () => { game.state = 'START'; showScreen('screen-start'); };
        function resize() { canvas.width = stage.clientWidth; canvas.height = stage.clientHeight; }
        window.onresize = resize;
        
        // Memulai Loading Aset
        initAllAssets();
    </script>
</body>
</html>
