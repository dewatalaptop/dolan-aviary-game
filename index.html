<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dolan Aviary - Wing Tap</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        /* --- BASE STYLES --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body {
            margin: 0; padding: 0;
            height: 100dvh; width: 100vw;
            background-color: #333;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden; touch-action: none; 
            display: flex; justify-content: center; align-items: center;
        }

        #game-stage {
            position: relative;
            width: 100%; max-width: 480px; height: 100%;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            /* Ganti warna background dasar menjadi biru langit */
            background: #87CEEB; 
        }

        canvas { display: block; width: 100%; height: 100%; z-index: 1; image-rendering: pixelated; }

        /* --- UI LAYERS --- */
        .ui-layer { position: absolute; width: 100%; pointer-events: none; z-index: 50; text-align: center; }
        
        #score-display {
            top: 10%; font-size: 3.5rem; color: white;
            -webkit-text-stroke: 3px #000; text-shadow: 4px 4px 0 #000;
            transition: transform 0.1s;
        }
        .score-pop { transform: scale(1.3); }

        #tutorial-hint {
            top: 50%; width: 100%;
            font-size: 0.7rem; color: white;
            text-shadow: 2px 2px 0 #000;
            animation: pulse 1.5s infinite;
            display: none;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        #flash-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: white; opacity: 0; pointer-events: none; z-index: 99;
            transition: opacity 0.1s ease-out;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(2px);
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            z-index: 60; display: none;
        }

        /* --- USER PROFILE --- */
        #user-info {
            position: absolute; top: 15px; left: 15px; z-index: 70;
            display: flex; align-items: center; gap: 10px;
            background: rgba(255,255,255,0.9); padding: 6px 12px; border-radius: 25px;
            border: 2px solid #000; box-shadow: 2px 2px 0 #000;
            pointer-events: auto; display: none;
        }
        #user-avatar { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #000; }
        #user-name { color: #000; font-size: 0.6rem; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #loc-badge { font-size: 0.5rem; color: #555; display: block; margin-top: 2px; }

        /* --- BUTTONS --- */
        .btn {
            background: #E86101; border: 2px solid #fff;
            box-shadow: 0 4px 0 #000; color: white;
            padding: 14px 20px; font-size: 0.8rem;
            font-family: inherit; cursor: pointer;
            border-radius: 8px; margin: 8px;
            text-transform: uppercase; width: 85%; max-width: 280px;
            pointer-events: auto; position: relative;
        }
        .btn:active { top: 4px; box-shadow: 0 0 0 #000; transform: scale(0.98); }
        .btn-google { background: #4285F4; border-color: #fff; }
        .btn-green { background: #51CF66; box-shadow: 0 4px 0 #2b8a3e; }

        /* --- LEADERBOARD --- */
        .lb-container {
            width: 90%; max-width: 320px; background: #ded895;
            border: 4px solid #543847; border-radius: 10px;
            padding: 10px; margin-bottom: 15px; pointer-events: auto;
        }
        .tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab {
            flex: 1; padding: 8px; font-size: 0.6rem; cursor: pointer;
            background: #e9af60; border: 2px solid #543847; color: #543847; text-align: center;
        }
        .tab.active { background: #E86101; color: white; border-color: #fff; }

        #lb-list { height: 160px; overflow-y: auto; background: #fff; border: 2px solid #543847; padding: 5px; }
        .lb-row {
            display: flex; justify-content: space-between; padding: 6px;
            border-bottom: 1px dashed #ccc; font-size: 0.6rem; color: #333;
        }
        .lb-row:nth-child(1) { background: #fff5cc; font-weight: bold; color: #d35400; }
        .lb-city { font-size: 0.5rem; color: #888; margin-left: 5px; }
        .lb-me { background-color: #dbe4ff !important; border-left: 4px solid #4285F4; }
    </style>
</head>
<body>

    <div id="game-stage">
        <canvas id="gameCanvas"></canvas>
        <div class="ui-layer" id="score-display">0</div>
        <div class="ui-layer" id="tutorial-hint">TAP / SPASI UNTUK TERBANG</div>
        <div id="flash-overlay"></div>
        
        <div id="user-info">
            <img id="user-avatar" src="" alt="">
            <div>
                <div id="user-name">Player</div>
                <div id="loc-badge">üìç Mencari Lokasi...</div>
            </div>
        </div>

        <div id="screen-start" class="screen" style="display: flex;">
            <h1 style="color:#00a8ff; -webkit-text-stroke:2px #fff; text-shadow:4px 4px 0 #000; font-size:2.2rem; text-align:center; margin-bottom:10px; line-height: 1.2;">
                DOLAN<br>AVIARY
            </h1>
            
            <div id="login-section" style="width:100%; text-align:center;">
                <p style="color:#fff; font-size:0.6rem; margin-bottom:15px; text-shadow: 2px 2px 0 #000;">Login untuk Simpan Skor</p>
                <button class="btn btn-google" id="btn-login">üîë Login Google</button>
                <br>
                <button class="btn btn-green" id="btn-guest">Main Tanpa Login</button>
            </div>
            
            <div id="play-section" style="display:none; text-align:center; width: 100%;">
                <button class="btn btn-green" id="btn-start" style="font-size: 1rem;">START ‚ñ∂</button>
                <button class="btn" id="btn-logout" style="background:#555; width:auto; font-size:0.6rem; padding: 10px;">Logout</button>
            </div>
        </div>

        <div id="screen-over" class="screen">
            <h2 style="color:#E86101; -webkit-text-stroke:2px #fff; text-shadow:3px 3px 0 #000; font-size:2rem; margin-bottom:15px;">GAME OVER</h2>
            <div style="background:#ded895; border:3px solid #543847; padding:10px; border-radius:8px; width:120px; text-align:center; margin-bottom:15px; box-shadow: 4px 4px 0 #000;">
                <div style="font-size:0.6rem; color:#E86101;">SKOR</div>
                <div id="final-score" style="font-size:2rem; color:#fff; -webkit-text-stroke:1px #000;">0</div>
            </div>
            <div class="lb-container">
                <div class="tabs">
                    <div class="tab active" id="tab-global">GLOBAL</div>
                    <div class="tab" id="tab-local">LOKAL</div>
                </div>
                <div id="lb-list">
                    <div style="text-align:center; padding:20px; font-size:0.6rem; color:#888;">Memuat...</div>
                </div>
            </div>
            <button class="btn btn-green" id="btn-restart">MAIN LAGI ‚Ü∫</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } 
               from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, where, onSnapshot } 
               from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDH6cBMyBCNdzG_tdJNs28AZZIm8HnO8l4",
            authDomain: "flytap-ca3ee.firebaseapp.com",
            projectId: "flytap-ca3ee",
            storageBucket: "flytap-ca3ee.firebasestorage.app",
            messagingSenderId: "690738199480",
            appId: "1:690738199480:web:b1b442690440db79016d4d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let playerCity = "Unknown";
        let lbMode = 'global';
        let unsubscribe = null;
        let userHighScore = 0; 

        async function detectLocation() {
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                if(data.city) {
                    playerCity = data.city;
                    document.getElementById('loc-badge').innerText = `üìç ${playerCity}`;
                }
            } catch(e) { console.log("Loc fail"); }
        }
        detectLocation();

        const uiLogin = document.getElementById('login-section');
        const uiPlay = document.getElementById('play-section');
        const uiInfo = document.getElementById('user-info');

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                uiLogin.style.display = 'none';
                uiPlay.style.display = 'block';
                uiInfo.style.display = 'flex';
                document.getElementById('user-name').innerText = user.displayName;
                document.getElementById('user-avatar').src = user.photoURL;
                loadLeaderboard();
            } else {
                uiLogin.style.display = 'block';
                uiPlay.style.display = 'none';
                uiInfo.style.display = 'none';
                userHighScore = 0;
            }
        });

        document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('btn-logout').onclick = () => signOut(auth);
        document.getElementById('btn-guest').onclick = () => { game.start(); };

        const lbList = document.getElementById('lb-list');
        const tabGlobal = document.getElementById('tab-global');
        const tabLocal = document.getElementById('tab-local');

        function switchTab(mode) {
            lbMode = mode;
            if(mode === 'global') {
                tabGlobal.classList.add('active'); tabLocal.classList.remove('active');
            } else {
                tabGlobal.classList.remove('active'); tabLocal.classList.add('active');
            }
            loadLeaderboard();
        }

        tabGlobal.onclick = () => switchTab('global');
        tabLocal.onclick = () => switchTab('local');

        function loadLeaderboard() {
            if(unsubscribe) unsubscribe();
            lbList.innerHTML = '<div style="text-align:center; padding:20px; font-size:0.6rem;">Memuat...</div>';

            let q;
            const ref = collection(db, "leaderboard");

            if (lbMode === 'local') {
                q = query(ref, where("city", "==", playerCity), orderBy("score", "desc"), limit(10));
            } else {
                q = query(ref, orderBy("score", "desc"), limit(10));
            }

            unsubscribe = onSnapshot(q, (snapshot) => {
                lbList.innerHTML = "";
                if(snapshot.empty) {
                    lbList.innerHTML = `<div style="text-align:center; padding:20px; font-size:0.6rem;">Belum ada skor.</div>`;
                    return;
                }
                let rank = 1;
                snapshot.forEach((doc) => {
                    const d = doc.data();
                    const isMe = currentUser && d.uid === currentUser.uid;
                    if(isMe && d.score > userHighScore) { userHighScore = d.score; }

                    const row = document.createElement('div');
                    row.className = 'lb-row';
                    if(isMe) row.classList.add('lb-me');
                    
                    let locTag = lbMode === 'global' ? `<span class="lb-city">(${d.city||'?'})</span>` : '';
                    
                    row.innerHTML = `
                        <span style="flex:1; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
                            #${rank} ${d.name} ${locTag}
                        </span>
                        <span style="font-weight:bold; color:#E86101;">${d.score}</span>
                    `;
                    lbList.appendChild(row);
                    rank++;
                });
            });
        }

        window.saveScore = async (score) => {
            if (!currentUser || score === 0) return;
            if (score <= userHighScore) return;
            try {
                await addDoc(collection(db, "leaderboard"), {
                    name: currentUser.displayName,
                    uid: currentUser.uid,
                    photo: currentUser.photoURL,
                    score: score,
                    city: playerCity,
                    timestamp: new Date()
                });
                userHighScore = score;
            } catch (e) { console.error(e); }
        };
    </script>

    <script>
        // --- AUDIO ENGINE (WEB AUDIO API) ---
        const AudioEngine = {
            ctx: null,
            init: function() {
                if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            play: function(type) {
                if(!this.ctx) return;
                if(this.ctx.state === 'suspended') this.ctx.resume();
                
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.connect(gain);
                gain.connect(this.ctx.destination);

                const now = this.ctx.currentTime;
                
                if (type === 'jump') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(300, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'score') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(1000, now);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    osc.start(now);
                    osc.stop(now + 0.2);
                } else if (type === 'hit') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(100, now);
                    osc.frequency.linearRampToValueAtTime(50, now + 0.3);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                }
            }
        };

        // --- GAME ENGINE ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });

        const CONFIG = {
            gravity: 1100,
            jump: 320,
            speed: 150,
            gap: 115, // Sedikit diperlebar agar lebih mudah melihat pohon
            pipeW: 52 
        };

        const assets = {};

        function initAssets() {
            // Merak (Peacock) - Ganti burung kuning
            // Ukuran kanvas diperbesar sedikit untuk menampung ekor
            const cB1 = createAssetCanvas(40, 30); drawPeacock(cB1.ctx, 0); assets.birdUp = cB1.cvs;
            const cB2 = createAssetCanvas(40, 30); drawPeacock(cB2.ctx, 4); assets.birdDown = cB2.cvs;
            
            // Pohon (Tree) - Ganti pipa hijau
            const cP = createAssetCanvas(CONFIG.pipeW, 600); drawTreeLog(cP.ctx); assets.pipe = cP.cvs;
            
            // Tanah Sawah (Ground)
            const cG = createAssetCanvas(480, 112); drawRiceGround(cG.ctx); assets.ground = cG.cvs;
            
            // Background Sawah Jauh & Teks (Far BG) - Ganti City
            const cC = createAssetCanvas(480, 250); drawRiceFieldBg(cC.ctx); assets.bgFar = cC.cvs;
            
            // Background Sawah Tengah & Hewan (Mid BG) - Ganti Bush
            const cS = createAssetCanvas(480, 100); drawMidAnimals(cS.ctx); assets.bgMid = cS.cvs;
        }

        function createAssetCanvas(w, h) {
            const c = document.createElement('canvas'); c.width = w; c.height = h;
            // Penting: Set font di sini agar bisa dipakai di fungsi draw
            c.getContext('2d').font = "16px 'Press Start 2P'"; 
            return { cvs: c, ctx: c.getContext('2d') };
        }

        // --- FUNGSI GAMBAR BARU (PIXEL ART PROCEDURAL) ---

        // 1. Gambar Merak (Peacock)
        function drawPeacock(ctx, wingState) {
             ctx.imageSmoothingEnabled = false;
            // Ekor Kipas (Belakang)
            ctx.fillStyle = "#006600"; // Hijau Tua
            ctx.beginPath();
            ctx.ellipse(15, 15, 14, 14, 0, Math.PI * 0.1, Math.PI * 1.9); // Lingkaran tidak penuh
            ctx.fill();
            // Detail bulu ekor (bintik)
            ctx.fillStyle = "#00cc99"; // Hijau terang/Teal
            for(let i=0; i<5; i++) {
                 let angle = (Math.PI/3) + (i * Math.PI/6);
                 ctx.beginPath(); ctx.arc(15 + Math.cos(angle)*10, 15 + Math.sin(angle)*10, 3, 0, Math.PI*2); ctx.fill();
            }

            // Tubuh Biru
            ctx.fillStyle = "#0000cc"; // Biru tua
            ctx.fillRect(18, 10, 12, 10); // Badan kotak
            
            // Kepala & Leher
            ctx.fillStyle = "#0033cc"; // Biru lebih terang
            ctx.fillRect(26, 6, 8, 8); // Kepala
            
            // Jambul
            ctx.fillStyle = "#00ccff";
            ctx.fillRect(30, 2, 2, 4);
            ctx.fillRect(28, 3, 6, 2);

            // Mata & Paruh
            ctx.fillStyle = "#FFF"; ctx.fillRect(30, 8, 2, 2); // Mata putih
            ctx.fillStyle = "#FFD700"; ctx.fillRect(34, 9, 4, 2); // Paruh kuning

            // Sayap (Bergerak)
            ctx.fillStyle = "#000099"; // Biru sayap
            let wy = 12 + (wingState ? 2 : 0); // Posisi sayap naik/turun
            ctx.fillRect(20, wy, 8, 6);
        }

        // 2. Gambar Pohon (Pengganti Pipa)
        function drawTreeLog(ctx) {
            // Batang Kayu Gradient
            const grad = ctx.createLinearGradient(0,0,CONFIG.pipeW,0);
            grad.addColorStop(0, "#4d2600"); // Coklat tua
            grad.addColorStop(0.3, "#663300");
            grad.addColorStop(0.7, "#804000"); // Coklat agak terang
            grad.addColorStop(1, "#4d2600");
            ctx.fillStyle = grad; ctx.fillRect(0,0,CONFIG.pipeW,600);
            
            // Tekstur Kulit Kayu (Garis pixel)
            ctx.fillStyle = "#331a00";
            for(let i=0; i<600; i+=20) {
                 ctx.fillRect(Math.random()*CONFIG.pipeW, i, Math.random()*10, 2);
            }

            // Dedaunan di pinggir batang
            ctx.fillStyle = "#228B22"; // Forest Green
            for(let i=0; i<600; i+=30) {
                 // Kiri
                 ctx.beginPath(); ctx.arc(0, i + Math.random()*10, 8 + Math.random()*4, 0, Math.PI*2); ctx.fill();
                 // Kanan
                 ctx.beginPath(); ctx.arc(CONFIG.pipeW, i + Math.random()*10 + 15, 8 + Math.random()*4, 0, Math.PI*2); ctx.fill();
            }
            // Ujung Pipa (Sekarang terlihat seperti potongan kayu)
            ctx.fillStyle = "#a65300"; ctx.fillRect(0,0,CONFIG.pipeW,10);
            ctx.fillStyle = "#a65300"; ctx.fillRect(0,590,CONFIG.pipeW,10);
        }

        // 3. Gambar Tanah Sawah
        function drawRiceGround(g) {
            // Lapisan lumpur/tanah atas
            g.fillStyle = "#8B4513"; g.fillRect(0,0,480,20);
            // Lapisan air/tanah basah
            g.fillStyle = "#A0522D"; g.fillRect(0,20,480,92);
            // Pematang sawah (garis)
            g.strokeStyle = "#5c2e0e"; g.lineWidth = 2;
            g.beginPath(); g.moveTo(0,20); g.lineTo(480,20); g.stroke();
            
            // Tanaman Padi kecil (pixel dots)
            g.fillStyle = "#7CFC00"; // Lawn Green
            for(let i=0; i<480; i+=5) {
                if(Math.random() > 0.5) g.fillRect(i, 5 + Math.random()*10, 2, 3);
            }
        }

        // 4. Background Jauh: Hamparan Sawah & Teks "Dolan Aviary"
        function drawRiceFieldBg(c) {
            // Gunung Jauh
            c.fillStyle = "#556B2F"; // Dark Olive Green
            c.beginPath(); c.moveTo(0, 180); 
            c.lineTo(100, 120); c.lineTo(250, 160); c.lineTo(400, 100); c.lineTo(480, 170);
            c.lineTo(480, 250); c.lineTo(0, 250); c.fill();

            // Teras Sawah 1 (Jauh)
            c.fillStyle = "#6B8E23"; // Olive Drab
            c.fillRect(0, 180, 480, 70);
             // Teras Sawah 2 (Lebih dekat)
            c.fillStyle = "#7CFC00"; // Lawn Green
            c.fillRect(0, 220, 480, 30);

            // TULISAN "Dolan Aviary" Pixelated
            c.fillStyle = "white";
            c.shadowColor = "black";
            c.shadowBlur = 0;
            c.shadowOffsetX = 2; c.shadowOffsetY = 2;
            c.textAlign = "center";
            // Menggunakan font yang sudah di-load di <head>
            c.fillText("DOLAN AVIARY", 240, 80);
            c.shadowOffsetX = 0; c.shadowOffsetY = 0; // Reset shadow
        }

        // 5. Background Tengah: Jalan Setapak & Hewan Pixel
        function drawMidAnimals(s) {
            // Jalan setapak di tengah sawah
            s.fillStyle = "#d2b48c"; // Tan
            s.fillRect(0, 60, 480, 20);
            s.strokeStyle = "#a08060"; s.lineWidth=2;
            s.beginPath(); s.moveTo(0,60); s.lineTo(480,60); s.stroke();

            // --- Pixel Animals (Sangat Sederhana) ---
            
            // Rusa (Deer) - Coklat
            let dx = 50; let dy = 45;
            s.fillStyle = "#8B4513"; // Badan
            s.fillRect(dx, dy, 14, 10); 
            s.fillRect(dx+10, dy-6, 6, 8); // Leher/Kepala
            s.fillStyle = "#D2691E"; // Kaki/Tanduk
            s.fillRect(dx+2, dy+10, 2, 6); s.fillRect(dx+10, dy+10, 2, 6); // Kaki
            s.fillRect(dx+10, dy-10, 2, 4); s.fillRect(dx+14, dy-10, 2, 4); // Tanduk

            // Kelinci (Rabbit) - Putih
            let rx = 200; let ry = 55;
            s.fillStyle = "#FFF";
            s.fillRect(rx, ry, 10, 8); // Badan
            s.fillRect(rx+8, ry-4, 4, 6); // Kepala
            s.fillRect(rx+8, ry-8, 2, 4); s.fillRect(rx+11, ry-8, 2, 4); // Telinga

            // Ayam (Chicken) - Merah/Putih
            let cx = 350; let cy = 52;
            s.fillStyle = "#FFF"; s.fillRect(cx, cy, 8, 8); // Badan
            s.fillStyle = "#FF0000"; s.fillRect(cx+6, cy-2, 4, 4); // Kepala/Jengger
            s.fillStyle = "#FFD700"; s.fillRect(cx+9, cy, 2, 2); // Paruh
        }

        // --- END FUNGSI GAMBAR BARU ---


        const game = {
            state: 'START', score: 0,
            bird: { y: 0, v: 0, rot: 0 },
            pipes: [],
            bgOff: 0, cityOff: 0, groundOff: 0,
            timeAccum: 0,
            graceTime: 0, 
            lastJump: 0,  
            
            start: function() {
                resize();
                AudioEngine.init(); // Init Audio Context on interaction
                this.state = 'PLAY';
                this.bird.y = canvas.height / 2; this.bird.v = 0; this.bird.rot = 0;
                this.pipes = []; this.score = 0; this.timeAccum = 0;
                this.graceTime = 1.0; 
                this.lastJump = 0;
                
                document.getElementById('score-display').innerText = 0;
                document.getElementById('score-display').style.display = 'block'; 
                document.getElementById('tutorial-hint').style.display = 'block';
                setTimeout(() => document.getElementById('tutorial-hint').style.display = 'none', 2000);

                showScreen(null);
            },
            
            over: function() {
                AudioEngine.play('hit'); // SOUND: HIT
                this.state = 'OVER';
                const flash = document.getElementById('flash-overlay');
                flash.style.opacity = 0.8;
                setTimeout(() => flash.style.opacity = 0, 100);

                document.getElementById('final-score').innerText = this.score;
                showScreen('screen-over');
                if(window.saveScore) window.saveScore(this.score);
            }
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            if(id) document.getElementById(id).style.display = 'flex';
        }

        let lastTime = performance.now();

        function loop(timestamp) {
            const dt = Math.min((timestamp - lastTime) / 1000, 0.1);
            lastTime = timestamp;

            if (game.state === 'PLAY') {
                updatePhysics(dt);
            } else if (game.state === 'START') {
                game.groundOff = (game.groundOff + CONFIG.speed * dt) % 20; 
                game.cityOff = (game.cityOff + CONFIG.speed * 0.1 * dt) % 480;
                game.bird.y = canvas.height/2 + Math.sin(timestamp/300)*8;
            }
            draw(dt); requestAnimationFrame(loop);
        }

        function updatePhysics(dt) {
            if (game.graceTime > 0) game.graceTime -= dt;

            game.bird.v += CONFIG.gravity * dt;
            game.bird.y += game.bird.v * dt;
            if(game.bird.v < 0) game.bird.rot = -0.4; // Rotasi naik sedikit dikurangi
            else {
                game.bird.rot += 2 * dt; 
                if(game.bird.rot > 1.2) game.bird.rot = 1.2; // Rotasi turun maksimal dikurangi
            }

            game.groundOff = (game.groundOff + CONFIG.speed * dt) % 20;
            game.bgOff = (game.bgOff + CONFIG.speed * 0.5 * dt) % 480; 
            game.cityOff = (game.cityOff + CONFIG.speed * 0.1 * dt) % 480; 

            game.timeAccum += dt;
            // Interval muncul pipa dipercepat sedikit
            if(game.timeAccum > 1.5) { 
                game.timeAccum = 0;
                
                // --- FIX 1: SMART PIPE SMOOTHING ---
                let groundY = canvas.height - 112;
                let minSafe = 60; 
                let maxSafe = groundY - CONFIG.gap - 60;
                
                let h;
                if(game.pipes.length === 0) {
                     h = Math.floor(Math.random() * (maxSafe - minSafe + 1) + minSafe);
                } else {
                    let prevH = game.pipes[game.pipes.length - 1].topH;
                    let maxChange = 220; 
                    let change = (Math.random() * maxChange * 2) - maxChange;
                    h = prevH + change;
                    if (h < minSafe) h = minSafe;
                    if (h > maxSafe) h = maxSafe;
                }

                game.pipes.push({ x: canvas.width, topH: h, passed: false });
            }

            // Hitbox burung sedikit disesuaikan untuk merak
            const bX = 60; const bR = 14; 
            for(let i=0; i<game.pipes.length; i++) {
                let p = game.pipes[i];
                p.x -= CONFIG.speed * dt;
                
                if (bX + bR > p.x && bX - bR < p.x + CONFIG.pipeW) {
                    // Tambahkan toleransi 5px pada celah agar tidak terlalu sulit
                    if (game.bird.y - bR < p.topH + 5 || game.bird.y + bR > p.topH + CONFIG.gap - 5) {
                        if (game.graceTime <= 0) game.over();
                    }
                }
                
                if (p.x + CONFIG.pipeW < bX && !p.passed) {
                    game.score++;
                    AudioEngine.play('score'); // SOUND: SCORE
                    const sd = document.getElementById('score-display');
                    sd.innerText = game.score;
                    sd.classList.remove('score-pop');
                    void sd.offsetWidth; 
                    sd.classList.add('score-pop');
                    p.passed = true;
                }
                if (p.x < -CONFIG.pipeW) { game.pipes.shift(); i--; }
            }

            if(game.bird.y >= canvas.height - 112 - 15) game.over();
        }

        function draw(dt) {
            // Warna Langit Biru Cerah (Ganti dari teal sebelumnya)
            ctx.fillStyle = "#87CEEB"; ctx.fillRect(0,0, canvas.width, canvas.height);
            
            let groundY = canvas.height - 112;
            
            // Draw Far BG (Sawah Jauh & Teks)
            let co = Math.floor(game.cityOff);
            ctx.drawImage(assets.bgFar, -co, groundY - 200); ctx.drawImage(assets.bgFar, 480-co, groundY - 200);
            
            // Draw Mid BG (Jalan & Hewan)
            let bo = Math.floor(game.bgOff);
            ctx.drawImage(assets.bgMid, -bo, groundY - 80); ctx.drawImage(assets.bgMid, 480-bo, groundY - 80);
            
            // Draw Pipes (Pohon)
            for(let p of game.pipes) {
                let px = Math.floor(p.x);
                ctx.save(); ctx.translate(px, p.topH); ctx.scale(1, -1); ctx.drawImage(assets.pipe, 0, 0); ctx.restore();
                ctx.drawImage(assets.pipe, px, p.topH + CONFIG.gap);
            }
            
            // Draw Ground (Tanah Sawah)
            let go = Math.floor(game.groundOff);
            for(let i=-1; i<Math.ceil(canvas.width/480)+1; i++) { ctx.drawImage(assets.ground, i*480 - go, groundY); }
            
            // Draw Bird (Merak)
            ctx.save();
            ctx.translate(60, game.bird.y);
            ctx.rotate(game.bird.rot);
            if (game.graceTime > 0 && Math.floor(Date.now() / 100) % 2 === 0) {
                ctx.globalAlpha = 0.5;
            }

            let birdAsset = assets.birdUp;
            if (game.state === 'PLAY') {
                if (game.bird.v < 0 || Math.sin(Date.now() / 50) > 0) birdAsset = assets.birdDown;
            } else {
                if (Math.sin(Date.now() / 200) > 0) birdAsset = assets.birdDown;
            }
            // Offset gambar disesuaikan karena ukuran merak berbeda
            ctx.drawImage(birdAsset, -20, -15);
            ctx.restore();
            ctx.globalAlpha = 1.0;
        }

        function inputAction(e) {
            if(e.target.closest('button') || e.target.closest('.lb-container')) return;
            
            if(game.state === 'START') {
                game.start();
            } else if(game.state === 'PLAY') {
                const now = Date.now();
                if (now - game.lastJump > 120) { 
                    game.bird.v = -CONFIG.jump;
                    game.lastJump = now;
                    AudioEngine.play('jump'); // SOUND: JUMP
                    document.getElementById('tutorial-hint').style.display = 'none';
                }
            }
        }

        const stage = document.getElementById('game-stage');
        stage.addEventListener('pointerdown', inputAction);
        window.addEventListener('keydown', (e) => {
            if(['Space', 'ArrowUp', 'KeyW'].includes(e.code)) {
                inputAction(e);
            }
        });

        document.getElementById('btn-start').onclick = () => game.start();
        document.getElementById('btn-restart').onclick = () => {
            game.state = 'START'; showScreen('screen-start');
        };

        function resize() {
            canvas.width = stage.clientWidth; canvas.height = stage.clientHeight;
        }
        window.onresize = resize;
        
        // Tunggu font termuat sebentar sebelum init aset agar teks "Dolan Aviary" tergambar benar
        setTimeout(() => {
             initAssets(); resize(); requestAnimationFrame(loop);
        }, 300);
       
    </script>
</body>
</html>

