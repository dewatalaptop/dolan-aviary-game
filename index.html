<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dolan Sawah - Clean Pixel Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body {
            margin: 0; padding: 0;
            height: 100dvh; width: 100vw;
            background-color: #222;
            font-family: 'Press Start 2P', cursive; 
            overflow: hidden; touch-action: none; 
            display: flex; justify-content: center; align-items: center;
        }

        #game-stage {
            position: relative;
            width: 100%; max-width: 480px; height: 100%;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            background: #4fa4b8; /* Warna langit dasar */
        }

        canvas { 
            display: block; width: 100%; height: 100%; z-index: 1; 
            image-rendering: pixelated; /* KUNCI KETAJAMAN */
            image-rendering: crisp-edges; 
        }

        /* --- UI Styles --- */
        .ui-layer { position: absolute; width: 100%; pointer-events: none; z-index: 50; text-align: center; }
        
        #score-display {
            top: 10%; font-size: 2.5rem; color: #FFD700; 
            text-shadow: 4px 4px 0 #000; 
            transition: transform 0.1s;
        }
        .score-pop { transform: scale(1.3); }

        #tutorial-hint {
            top: 60%; width: 100%;
            font-size: 0.7rem; color: #fff;
            text-shadow: 2px 2px 0 #000;
            animation: pulse 1.5s infinite;
            display: none; letter-spacing: 1px; line-height: 1.5;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        #flash-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: white; opacity: 0; pointer-events: none; z-index: 99;
            transition: opacity 0.1s ease-out;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center;
            z-index: 60; display: none;
        }

        #loading-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #4fa4b8; z-index: 100;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            color: white; font-size: 0.8rem; text-shadow: 2px 2px 0 #000; line-height: 1.5; text-align: center;
        }

        #user-info {
            position: absolute; top: 15px; left: 15px; z-index: 70;
            display: flex; align-items: center; gap: 10px;
            background: #e4c684; padding: 8px; 
            border: 4px solid #000;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
            pointer-events: auto; display: none; color: #000; font-size: 0.6rem;
        }
        #user-avatar { width: 32px; height: 32px; border: 2px solid #000; image-rendering: pixelated; }

        .btn {
            background: #ff7f50; 
            border: 4px solid #000;
            box-shadow: 4px 4px 0 #000;
            color: white; padding: 16px 20px; font-size: 0.8rem;
            font-family: inherit; cursor: pointer; margin: 10px;
            text-transform: uppercase; width: 90%; max-width: 320px;
            pointer-events: auto; position: relative; text-shadow: 2px 2px 0 #000;
        }
        .btn:active { top: 4px; box-shadow: 0 0 0 #000; }
        .btn-google { background: #4285F4; }
        .btn-green { background: #73BF2E; }

        .lb-container {
            width: 90%; max-width: 340px; background: #e4c684;
            border: 4px solid #000;
            padding: 10px; margin-bottom: 20px; pointer-events: auto;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.5); font-size: 0.7rem;
        }
        .tab {
            flex: 1; padding: 8px; cursor: pointer;
            background: #c0a060; border: 2px solid #000; color: #000; text-align: center;
            margin: 0 2px;
        }
        .tab.active { background: #ff7f50; color: white; border-bottom: none; transform: translateY(2px); }
        #lb-list { height: 180px; overflow-y: auto; background: #fff; border: 2px solid #000; padding: 8px; }
        .lb-row { display: flex; justify-content: space-between; margin-bottom: 4px;}
    </style>
</head>
<body>

    <div id="game-stage">
        <canvas id="gameCanvas"></canvas>
        
        <div id="loading-screen">
            <div style="font-size: 1.2rem; margin-bottom: 10px;">MEMUAT PIXEL...</div>
            <div>Menata Sawah & Gunung</div>
        </div>

        <div class="ui-layer" id="score-display" style="display:none;">0</div>
        <div class="ui-layer" id="tutorial-hint">TAP / SPASI<br>UNTUK TERBANG</div>
        <div id="flash-overlay"></div>
        
        <div id="user-info">
            <img id="user-avatar" src="" alt="">
            <div>
                <div id="user-name">Player</div>
                <div id="loc-badge">üìç Cari Lokasi...</div>
            </div>
        </div>

        <div id="screen-start" class="screen" style="display: none;">
            <h1 style="color:#FFD700; text-shadow: 4px 4px 0 #000, -4px -4px 0 #000, 4px -4px 0 #000, -4px 4px 0 #000; font-size:2rem; text-align:center; margin-bottom:30px; line-height: 1.2;">
                DOLAN<br>SAWAH
            </h1>
            
            <div id="login-section" style="width:100%; text-align:center;">
                <p style="color:#fff; font-size:0.7rem; margin-bottom:15px; text-shadow: 2px 2px 0 #000;">Login untuk Simpan Skor</p>
                <button class="btn btn-google" id="btn-login">üîë Login Google</button>
                <button class="btn btn-green" id="btn-guest">Main Tanpa Login</button>
            </div>
            
            <div id="play-section" style="display:none; text-align:center; width: 100%;">
                <button class="btn btn-green" id="btn-start" style="font-size: 1rem; padding: 20px 30px;">START ‚ñ∂</button>
                <button class="btn" id="btn-logout" style="background:#777; width:auto; font-size:0.6rem; padding: 12px 18px;">Logout</button>
            </div>
        </div>

        <div id="screen-over" class="screen">
            <h2 style="color:#FF6B6B; text-shadow:4px 4px 0 #000; font-size:1.8rem; margin-bottom:20px;">GAME OVER</h2>
            <div style="background:#e4c684; border:4px solid #000; padding:15px 25px; text-align:center; margin-bottom:20px; box-shadow: 6px 6px 0 rgba(0,0,0,0.5);">
                <div style="font-size:0.7rem; color:#000; margin-bottom: 5px;">SKOR KAMU</div>
                <div id="final-score" style="font-size:2.5rem; color:#E86101; text-shadow: 3px 3px 0 #000;">0</div>
            </div>
            <div class="lb-container">
                <div class="tabs" style="display: flex;">
                    <div class="tab active" id="tab-global">GLOBAL</div>
                    <div class="tab" id="tab-local">LOKAL</div>
                </div>
                <div id="lb-list">
                    <div style="text-align:center; padding:20px; font-size:0.6rem; color:#888;">Memuat...</div>
                </div>
            </div>
            <button class="btn btn-green" id="btn-restart" style="font-size: 0.8rem;">MAIN LAGI ‚Ü∫</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } 
               from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, where, onSnapshot } 
               from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDH6cBMyBCNdzG_tdJNs28AZZIm8HnO8l4",
            authDomain: "flytap-ca3ee.firebaseapp.com",
            projectId: "flytap-ca3ee",
            storageBucket: "flytap-ca3ee.firebasestorage.app",
            messagingSenderId: "690738199480",
            appId: "1:690738199480:web:b1b442690440db79016d4d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let playerCity = "Unknown";
        let lbMode = 'global';
        let unsubscribe = null;
        let userHighScore = 0; 

        async function detectLocation() {
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                if(data.city) {
                    playerCity = data.city;
                    document.getElementById('loc-badge').innerText = `üìç ${playerCity}`;
                }
            } catch(e) { console.log("Loc fail"); }
        }
        detectLocation();

        const uiLogin = document.getElementById('login-section');
        const uiPlay = document.getElementById('play-section');
        const uiInfo = document.getElementById('user-info');

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                uiLogin.style.display = 'none';
                uiPlay.style.display = 'block';
                uiInfo.style.display = 'flex';
                document.getElementById('user-name').innerText = user.displayName;
                document.getElementById('user-avatar').src = user.photoURL;
                loadLeaderboard();
            } else {
                uiLogin.style.display = 'block';
                uiPlay.style.display = 'none';
                uiInfo.style.display = 'none';
                userHighScore = 0;
            }
        });

        document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('btn-logout').onclick = () => signOut(auth);
        document.getElementById('btn-guest').onclick = () => { game.start(); };

        const lbList = document.getElementById('lb-list');
        const tabGlobal = document.getElementById('tab-global');
        const tabLocal = document.getElementById('tab-local');

        function switchTab(mode) {
            lbMode = mode;
            if(mode === 'global') {
                tabGlobal.classList.add('active'); tabLocal.classList.remove('active');
            } else {
                tabGlobal.classList.remove('active'); tabLocal.classList.add('active');
            }
            loadLeaderboard();
        }

        tabGlobal.onclick = () => switchTab('global');
        tabLocal.onclick = () => switchTab('local');

        function loadLeaderboard() {
            if(unsubscribe) unsubscribe();
            lbList.innerHTML = '<div style="text-align:center; padding:20px; font-size:0.6rem;">Memuat...</div>';

            let q;
            const ref = collection(db, "leaderboard");

            if (lbMode === 'local') {
                q = query(ref, where("city", "==", playerCity), orderBy("score", "desc"), limit(10));
            } else {
                q = query(ref, orderBy("score", "desc"), limit(10));
            }

            unsubscribe = onSnapshot(q, (snapshot) => {
                lbList.innerHTML = "";
                if(snapshot.empty) {
                    lbList.innerHTML = `<div style="text-align:center; padding:20px; font-size:0.6rem;">Belum ada skor.</div>`;
                    return;
                }
                let rank = 1;
                snapshot.forEach((doc) => {
                    const d = doc.data();
                    const isMe = currentUser && d.uid === currentUser.uid;
                    if(isMe && d.score > userHighScore) { userHighScore = d.score; }

                    const row = document.createElement('div');
                    row.className = 'lb-row';
                    if(isMe) row.style.color = "#E86101";
                    
                    let locTag = lbMode === 'global' ? `(${d.city||'?'})` : '';
                    
                    row.innerHTML = `
                        <span style="flex:1; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
                            #${rank} ${d.name} ${locTag}
                        </span>
                        <span>${d.score}</span>
                    `;
                    lbList.appendChild(row);
                    rank++;
                });
            });
        }

        window.saveScore = async (score) => {
            if (!currentUser || score === 0) return;
            if (score <= userHighScore) return;
            try {
                await addDoc(collection(db, "leaderboard"), {
                    name: currentUser.displayName,
                    uid: currentUser.uid,
                    photo: currentUser.photoURL,
                    score: score,
                    city: playerCity,
                    timestamp: new Date()
                });
                userHighScore = score;
            } catch (e) { console.error(e); }
        };
    </script>

    <script>
        // --- AUDIO ENGINE ---
        const AudioEngine = {
            ctx: null,
            init: function() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            play: function(type) {
                if(!this.ctx) return; if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.ctx.destination); const now = this.ctx.currentTime;
                
                if (type === 'jump') {
                    osc.type = 'square'; 
                    osc.frequency.setValueAtTime(300, now); osc.frequency.linearRampToValueAtTime(600, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                } else if (type === 'score') {
                    osc.type = 'square'; 
                    osc.frequency.setValueAtTime(800, now); osc.frequency.setValueAtTime(1200, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now); osc.stop(now + 0.2);
                } else if (type === 'hit') {
                    osc.type = 'sawtooth'; 
                    osc.frequency.setValueAtTime(200, now); osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                    gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                }
            }
        };

        // --- GAME ENGINE SETUP ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false }); 
        
        const CONFIG = {
            gravity: 1200, jump: 360, speed: 170,
            gap: 140, pipeW: 70
        };

        const assets = {
            pipe: null, ground: null, bgFar: null, bgMid: null,
            imgBirdUp: null, imgBirdDown: null, imgRusa: null, imgKelinci: null, imgDomba: null
        };

        const imageURLs = {
            birdUp: 'https://res.cloudinary.com/dn60ib3ur/image/upload/v1766581827/IMG_7776_qlmxw3.png',
            birdDown: 'https://res.cloudinary.com/dn60ib3ur/image/upload/v1766581827/IMG_7775_teoy4m.png',
            rusa: 'https://res.cloudinary.com/dn60ib3ur/image/upload/v1766583160/IMG_7781_s5gqsi.png',
            kelinci: 'https://res.cloudinary.com/dn60ib3ur/image/upload/v1766583166/IMG_7780_fdrcyi.png',
            domba: 'https://res.cloudinary.com/dn60ib3ur/image/upload/v1766583165/IMG_7782_f6h4cq.png'
        };

        function loadImg(url) {
            return new Promise((resolve, reject) => {
                const img = new Image(); img.crossOrigin = "Anonymous";
                img.onload = () => resolve(img); img.onerror = () => reject(url); img.src = url;
            });
        }

        async function initAllAssets() {
            try {
                const [bUp, bDown, rusa, kelinci, domba] = await Promise.all([
                    loadImg(imageURLs.birdUp), loadImg(imageURLs.birdDown),
                    loadImg(imageURLs.rusa), loadImg(imageURLs.kelinci), loadImg(imageURLs.domba)
                ]);
                assets.imgBirdUp = bUp; assets.imgBirdDown = bDown;
                assets.imgRusa = rusa; assets.imgKelinci = kelinci; assets.imgDomba = domba;

                // Create Procedural Assets
                const cP = createAssetCanvas(CONFIG.pipeW, 600); drawPixelLog(cP.ctx, CONFIG.pipeW, 600); assets.pipe = cP.cvs;
                const cG = createAssetCanvas(480, 130); drawCleanGround(cG.ctx, 480, 130); assets.ground = cG.cvs;
                
                // BG Jauh (Gunung)
                const cC = createAssetCanvas(480, 640); drawCleanBgFar(cC.ctx, 480, 640); assets.bgFar = cC.cvs;
                
                // BG Tengah (Sawah + Hewan)
                const cS = createAssetCanvas(480, 240); drawCleanBgMid(cS.ctx, 480, 240); assets.bgMid = cS.cvs;

                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('screen-start').style.display = 'flex';
                resize(); requestAnimationFrame(loop);

            } catch (err) {
                console.error("Gagal:", err);
                document.getElementById('loading-screen').innerHTML = "Gagal memuat aset.<br>Refresh halaman.";
            }
        }

        function createAssetCanvas(w, h) {
            const c = document.createElement('canvas'); c.width = w; c.height = h;
            const ctx = c.getContext('2d');
            ctx.imageSmoothingEnabled = false; 
            ctx.font = "16px 'Press Start 2P', cursive"; 
            return { cvs: c, ctx: ctx };
        }

        // --- ASSET DRAWING FUNCTIONS ---

        function drawPixelRect(ctx, x, y, w, h, color) {
            ctx.fillStyle = color; ctx.fillRect(Math.floor(x), Math.floor(y), Math.floor(w), Math.floor(h));
        }

        function drawPixelLog(ctx, w, h) {
            const cDark = "#3a2416"; const cMed = "#633d26"; const cLight = "#8a5a3a"; const cHigh = "#b07d54";
            drawPixelRect(ctx, 0, 0, w*0.2, h, cDark);
            drawPixelRect(ctx, w*0.2, 0, w*0.3, h, cMed);
            drawPixelRect(ctx, w*0.5, 0, w*0.3, h, cLight);
            drawPixelRect(ctx, w*0.8, 0, w*0.2, h, cHigh);
            for(let i=0; i<h; i+=16) drawPixelRect(ctx, Math.random()*w*0.8, i, 8, 4, cDark);
            drawLogEnd(ctx, 0, w, cDark, cMed, cLight);
            drawLogEnd(ctx, h-20, w, cDark, cMed, cLight);
        }
        function drawLogEnd(ctx, y, w, c1, c2, c3) {
            drawPixelRect(ctx, 0, y, w, 20, c1);
            drawPixelRect(ctx, 4, y+4, w-8, 12, c2);
            drawPixelRect(ctx, 12, y+8, w-24, 4, c3);
        }

        function drawCleanGround(ctx, w, h) {
            const P_SZ = 8;
            drawPixelRect(ctx, 0, 0, w, P_SZ*2, "#5cb85c");
            for(let x=0; x<w; x+=P_SZ*2) drawPixelRect(ctx, x, 0, P_SZ, P_SZ, "#71c971");
            drawPixelRect(ctx, 0, P_SZ*2, w, h-P_SZ*2, "#633d26");
            for(let x=0; x<w; x+=P_SZ*4) drawPixelRect(ctx, x, P_SZ*3, P_SZ*2, P_SZ, "#8a5a3a");
        }

        function drawCleanBgFar(ctx, w, h) {
            drawPixelRect(ctx, 0, 0, w, h*0.4, "#4fa4b8"); 
            drawPixelRect(ctx, 0, h*0.4, w, h*0.3, "#6dc2ca");
            drawPixelRect(ctx, 0, h*0.7, w, h*0.3, "#aaeaf0");

            drawBigCloud(ctx, 80, 120, 100); 
            drawBigCloud(ctx, 350, 80, 80); 
            drawBigCloud(ctx, 250, 220, 60);

            let gy = h - 180;
            drawTriangleMountain(ctx, 0, gy+50, w, 200, "#3a3a7a");
            drawTriangleMountain(ctx, -100, gy+80, w+200, 150, "#2a7a7a");
            drawTriangleMountain(ctx, -50, gy+120, w+100, 100, "#2a7a3a");
        }

        function drawBigCloud(ctx, x, y, s) {
             ctx.fillStyle = "#ffffff";
             let bs = s/4; 
             drawPixelRect(ctx, x-bs*2, y, bs*4, bs, "#fff"); 
             drawPixelRect(ctx, x-bs, y-bs, bs*2, bs, "#fff"); 
             drawPixelRect(ctx, x-bs*1.5, y+bs, bs*3, bs/2, "#fff"); 
        }

        function drawTriangleMountain(ctx, xStart, yBase, width, height, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(xStart, yBase);
            ctx.lineTo(xStart + width/2, yBase - height);
            ctx.lineTo(xStart + width, yBase);
            ctx.closePath();
            ctx.fill();
        }

        // --- BACKGROUND TENGAH (Sawah & Hewan) ---
        function drawCleanBgMid(ctx, w, h) {
            // Kita gambar sawah terasering
            // Teras 1 (Atas/Jauh) - Y: 0 - 60
            drawPixelRect(ctx, 0, 0, w, 60, "#71c971"); 
            drawPixelRect(ctx, 0, 55, w, 5, "#5cb85c"); // Garis Pematang 1

            // Teras 2 (Tengah) - Y: 60 - 140
            drawPixelRect(ctx, 0, 60, w, 80, "#8fbc8f");
            drawPixelRect(ctx, 0, 135, w, 5, "#71c971"); // Garis Pematang 2

            // Teras 3 (Bawah/Dekat) - Y: 140 - 240
            drawPixelRect(ctx, 0, 140, w, 100, "#aedba3");

            // Jalan Tanah & Plang
            drawPixelRect(ctx, 200, 60, 80, 180, "#8a5a3a");
            const signX = 240; const signY = 60;
            drawPixelRect(ctx, signX-40, signY+30, 16, 100, "#633d26");
            drawPixelRect(ctx, signX+24, signY+30, 16, 100, "#633d26");
            ctx.fillStyle = "#b07d54"; ctx.fillRect(signX-80, signY-20, 160, 50);
            ctx.fillStyle = "#8a5a3a"; ctx.fillRect(signX-75, signY-15, 150, 40);
            drawPixelRect(ctx, signX-70, signY, 8, 8, "#3a2416");
            drawPixelRect(ctx, signX+62, signY, 8, 8, "#3a2416");
            ctx.fillStyle = "#ffffff"; 
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.shadowColor = "#000000"; ctx.shadowOffsetX = 2; ctx.shadowOffsetY = 2;
            ctx.fillText("DOLAN SAWAH", signX, signY+5);
            ctx.shadowColor = "transparent";

            // --- MENANAM HEWAN KE BACKGROUND (Agar ikut looping) ---
            // Fungsi helper menanam hewan
            const plantAnimal = (img, x, groundLineY, scale) => {
                if(!img) return;
                let sw = img.width * scale;
                let sh = img.height * scale;
                // Gambar tepat di atas garis pematang (groundLineY)
                ctx.drawImage(img, x - sw/2, groundLineY - sh + 2, sw, sh);
            };

            // Teras 1 (Garis Pematang di Y=55)
            plantAnimal(assets.imgDomba, 80, 55, 0.3);
            plantAnimal(assets.imgRusa, 420, 55, 0.35);

            // Teras 2 (Garis Pematang di Y=135)
            plantAnimal(assets.imgKelinci, 340, 135, 0.5);
            plantAnimal(assets.imgDomba, 100, 135, 0.55);

            // Teras 3 (Garis Pematang paling bawah sawah di Y=240, tapi kita taruh agak naik Y=230)
            plantAnimal(assets.imgRusa, 380, 230, 0.7);
            plantAnimal(assets.imgKelinci, 60, 230, 0.6);
        }

        // --- HELPER UNTUK TILING/LOOPING GAMBAR ---
        function drawLayer(ctx, img, speedOffset, yPos, imgW, imgH) {
            if(!img) return;
            // Hitung berapa kali gambar harus diulang
            const numTiles = Math.ceil(canvas.width / imgW) + 1;
            const offsetMod = Math.floor(speedOffset % imgW);

            for (let i = 0; i < numTiles; i++) {
                let xPos = (i * imgW) - offsetMod;
                ctx.drawImage(img, xPos, yPos);
            }
        }

        // --- GAME LOGIC ---
        const game = {
            state: 'START', score: 0,
            bird: { y: 0, v: 0, rot: 0 },
            pipes: [],
            bgOff: 0, midOff: 0, groundOff: 0,
            timeAccum: 0, graceTime: 0, lastJump: 0,  
            
            start: function() {
                resize(); AudioEngine.init(); 
                this.state = 'PLAY';
                this.bird.y = canvas.height / 2 - 50; this.bird.v = 0; this.bird.rot = 0;
                this.pipes = []; this.score = 0; this.timeAccum = 0;
                this.graceTime = 1.5; this.lastJump = 0;
                document.getElementById('score-display').innerText = 0;
                document.getElementById('score-display').style.display = 'block'; 
                document.getElementById('tutorial-hint').style.display = 'block';
                setTimeout(() => document.getElementById('tutorial-hint').style.display = 'none', 3000);
                showScreen(null);
            },
            
            over: function() {
                AudioEngine.play('hit'); this.state = 'OVER';
                const flash = document.getElementById('flash-overlay');
                flash.style.opacity = 0.6; setTimeout(() => flash.style.opacity = 0, 150);
                document.getElementById('final-score').innerText = this.score;
                showScreen('screen-over');
                if(window.saveScore) window.saveScore(this.score);
            }
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            if(id) document.getElementById(id).style.display = 'flex';
        }

        let lastTime = performance.now();
        function loop(timestamp) {
            const dt = Math.min((timestamp - lastTime) / 1000, 0.06);
            lastTime = timestamp;

            if (game.state === 'PLAY') updatePhysics(dt);
            else if (game.state === 'START') {
                // Auto scroll saat menu
                game.groundOff += CONFIG.speed * dt;
                game.midOff += CONFIG.speed * 0.1 * dt;
                game.bgOff += CONFIG.speed * 0.02 * dt;
                game.bird.y = canvas.height/2 - 50 + Math.sin(timestamp/300)*15;
            }
            draw(dt); requestAnimationFrame(loop);
        }

        function updatePhysics(dt) {
            if (game.graceTime > 0) game.graceTime -= dt;
            game.bird.v += CONFIG.gravity * dt; game.bird.y += game.bird.v * dt;
            if(game.bird.v < 0) game.bird.rot = Math.max(-0.4, game.bird.rot - 3 * dt);
            else game.bird.rot = Math.min(1.2, game.bird.rot + 2.5 * dt);

            // Pergerakan Parallax (Beda kecepatan tiap layer)
            game.groundOff += CONFIG.speed * dt;
            game.midOff += CONFIG.speed * 0.1 * dt; // Sawah pelan
            game.bgOff += CONFIG.speed * 0.02 * dt; // Gunung sangat pelan

            game.timeAccum += dt;
            if(game.timeAccum > 1.5) {
                game.timeAccum = 0;
                let groundY = canvas.height - 130; 
                let minSafe = 80; let maxSafe = groundY - CONFIG.gap - 80;
                let h;
                if(game.pipes.length === 0) h = Math.floor(Math.random() * (maxSafe - minSafe + 1) + minSafe);
                else {
                    let prevH = game.pipes[game.pipes.length - 1].topH;
                    let change = (Math.random() * 250 * 2) - 250; h = prevH + change;
                    if (h < minSafe) h = minSafe; if (h > maxSafe) h = maxSafe;
                }
                game.pipes.push({ x: canvas.width, topH: h, passed: false });
            }

            const bX = 60; const bW = 30; const bH = 28;
            for(let i=0; i<game.pipes.length; i++) {
                let p = game.pipes[i]; p.x -= CONFIG.speed * dt;
                if (bX + bW/2 > p.x + 4 && bX - bW/2 < p.x + CONFIG.pipeW - 4) {
                    if (game.bird.y - bH/2 < p.topH + 8 || game.bird.y + bH/2 > p.topH + CONFIG.gap - 8) {
                        if (game.graceTime <= 0) game.over();
                    }
                }
                if (p.x + CONFIG.pipeW < bX && !p.passed) {
                    game.score++; AudioEngine.play('score');
                    const sd = document.getElementById('score-display'); sd.innerText = game.score;
                    sd.classList.remove('score-pop'); void sd.offsetWidth; sd.classList.add('score-pop');
                    p.passed = true;
                }
                if (p.x < -CONFIG.pipeW) { game.pipes.shift(); i--; }
            }
            if(game.bird.y >= canvas.height - 130 - 20) game.over();
        }

        // --- DRAW FUNCTION (FIXED FOR TILING) ---
        function draw(dt) {
            ctx.clearRect(0,0,canvas.width, canvas.height);
            
            // 0. Warna Langit Dasar (Agar tidak bolong)
            ctx.fillStyle = "#4fa4b8"; ctx.fillRect(0,0,canvas.width,canvas.height);

            let groundY = canvas.height - 130;
            
            // 1. BG Jauh (Gunung) - Tiling
            // Posisi Y disesuaikan agar gunung pas di horizon
            drawLayer(ctx, assets.bgFar, game.bgOff, groundY - 510, 480, 640);

            // 2. BG Tengah (Sawah & Hewan) - Tiling
            let midY = groundY - 220; 
            drawLayer(ctx, assets.bgMid, game.midOff, midY, 480, 240);
            
            // 3. Pipa (Tetap manual karena koordinat dinamis)
            for(let p of game.pipes) {
                let px = Math.floor(p.x);
                ctx.save(); ctx.translate(px, p.topH); ctx.scale(1, -1); ctx.drawImage(assets.pipe, 0, 0); ctx.restore();
                ctx.drawImage(assets.pipe, px, p.topH + CONFIG.gap);
            }
            
            // 4. Tanah - Tiling
            drawLayer(ctx, assets.ground, game.groundOff, groundY, 480, 130);
            
            // 5. Burung
            ctx.save(); ctx.translate(60, game.bird.y); ctx.rotate(game.bird.rot);
            if (game.graceTime > 0 && Math.floor(Date.now() / 100) % 2 === 0) ctx.globalAlpha = 0.5;
            let birdImg = assets.imgBirdUp;
            if (game.state === 'PLAY') { if (game.bird.v > 100) birdImg = assets.imgBirdDown; } 
            else { if (Math.sin(Date.now() / 200) > 0) birdImg = assets.imgBirdDown; }
            if(birdImg) ctx.drawImage(birdImg, -30, -24, 60, 48); 
            ctx.restore(); ctx.globalAlpha = 1.0;
        }

        function inputAction(e) {
            if(e.target.closest('button') || e.target.closest('.lb-container')) return;
            if(game.state === 'START') game.start();
            else if(game.state === 'PLAY') {
                const now = Date.now();
                if (now - game.lastJump > 100) { 
                    game.bird.v = -CONFIG.jump; game.lastJump = now;
                    AudioEngine.play('jump'); document.getElementById('tutorial-hint').style.display = 'none';
                }
            }
        }

        const stage = document.getElementById('game-stage');
        stage.addEventListener('pointerdown', inputAction);
        window.addEventListener('keydown', (e) => { if(['Space', 'ArrowUp', 'KeyW'].includes(e.code)) inputAction(e); });
        document.getElementById('btn-start').onclick = () => game.start();
        document.getElementById('btn-restart').onclick = () => { game.state = 'START'; showScreen('screen-start'); };
        
        function resize() { 
            canvas.width = stage.clientWidth; canvas.height = stage.clientHeight; 
            ctx.imageSmoothingEnabled = false;
        }
        window.onresize = resize;
        
        initAllAssets();
    </script>
</body>
</html>
